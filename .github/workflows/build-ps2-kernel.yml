name: Build PS2 2.4.17 Kernel (ps2toolchain)

on:
  push:
  pull_request:
  workflow_dispatch:

defaults:
  run:
    shell: bash
    working-directory: linux-2.4.17_ps2  # Adjust to your kernel source directory

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARCH: mips
      CROSS_COMPILE: mipsEEel-linux-

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Show host info
        run: |
          uname -a
          docker version

      - name: Pull PS2 toolchain image
        run: |
          docker pull akuhak/ps2-legacy-woody-slim:latest

      - name: Build kernel inside PS2 container
        run: |
          # Run all build logic inside the container
          docker run --rm \
            -e ARCH \
            -e CROSS_COMPILE \
            -v "${GITHUB_WORKSPACE}:/work" \
            -w "/work/linux-2.4.17_ps2" \
            akuhak/ps2-legacy-woody-slim:latest \
            sh -c '
              echo "Toolchain info:"
              which "${CROSS_COMPILE}gcc" || echo "gcc not found"
              "${CROSS_COMPILE}gcc" -v || true
              uname -a

              echo "Running setup-ps2 (if present)..."
              if [ -x ./setup-ps2 ]; then
                ./setup-ps2
              else
                echo "setup-ps2 not found or not executable, skipping"
              fi

              echo "Running make oldconfig..."
              yes "" | make oldconfig || true

              echo "Running make dep..."
              make dep

              echo "Building kernel..."
              make -j"$(nproc)" vmlinux

              echo "Building modules (optional)..."
              make -j"$(nproc)" modules || true
              make modules_install INSTALL_MOD_PATH=/work/linux-2.4.17_ps2/rootfs
              tar cvf kernel-modules-2.4.17.tar -C /work/linux-2.4.17_ps2/rootfs/lib/modules .
              gzip kernel-modules-2.4.17.tar
              mv kernel-modules-2.4.17.tar.gz /work/linux-2.4.17_ps2/rootfs/

              echo "Preparing output..."
              ls -l rootfs
              mkdir -p rootfs/boot
              cp vmlinux rootfs/boot/vmlinux-2.4.17_mvl21
              cp System.map rootfs/boot/System.map-2.4.17_mvl21
            '


      - name: Upload kernel artifact
        uses: actions/upload-artifact@v5
        with:
          name: ps2-kernel-build
          path: |
            linux-2.4.17_ps2/rootfs
          if-no-files-found: warn
